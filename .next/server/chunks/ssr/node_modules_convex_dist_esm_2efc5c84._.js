module.exports=[50527,a=>{"use strict";a.s(["version",0,"1.31.4"])},21338,68517,10092,59230,95487,81773,a=>{"use strict";for(var b,c,d=[],e=[],f=Uint8Array,g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",h=0,i=g.length;h<i;++h)d[h]=g[h],e[g.charCodeAt(h)]=h;function j(a){var b=a.length;if(b%4>0)throw Error("Invalid string. Length must be a multiple of 4");var c=a.indexOf("=");-1===c&&(c=b);var d=c===b?0:4-c%4;return[c,d]}function k(a){var b=j(a),c=b[0],d=b[1];return(c+d)*3/4-d}function l(a){var b,c,d=j(a),g=d[0],h=d[1],i=new f((g+h)*3/4-h),k=0,l=h>0?g-4:g;for(c=0;c<l;c+=4)b=e[a.charCodeAt(c)]<<18|e[a.charCodeAt(c+1)]<<12|e[a.charCodeAt(c+2)]<<6|e[a.charCodeAt(c+3)],i[k++]=b>>16&255,i[k++]=b>>8&255,i[k++]=255&b;return 2===h&&(b=e[a.charCodeAt(c)]<<2|e[a.charCodeAt(c+1)]>>4,i[k++]=255&b),1===h&&(b=e[a.charCodeAt(c)]<<10|e[a.charCodeAt(c+1)]<<4|e[a.charCodeAt(c+2)]>>2,i[k++]=b>>8&255,i[k++]=255&b),i}function m(a){for(var b,c=a.length,e=c%3,f=[],g=0,h=c-e;g<h;g+=16383)f.push(function(a,b,c){for(var e,f=[],g=b;g<c;g+=3)e=(a[g]<<16&0xff0000)+(a[g+1]<<8&65280)+(255&a[g+2]),f.push(d[e>>18&63]+d[e>>12&63]+d[e>>6&63]+d[63&e]);return f.join("")}(a,g,g+16383>h?h:g+16383));return 1===e?f.push(d[(b=a[c-1])>>2]+d[b<<4&63]+"=="):2===e&&f.push(d[(b=(a[c-2]<<8)+a[c-1])>>10]+d[b>>4&63]+d[b<<2&63]+"="),f.join("")}function n(a){return m(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function o(a){if(void 0===a)return{};if(!q(a))throw Error(`The arguments to a Convex function must be an object. Received: ${a}`);return a}function p(a){if(void 0===a)throw Error("Client created with undefined deployment address. If you used an environment variable, check that it's set.");if("string"!=typeof a)throw Error(`Invalid deployment address: found ${a}".`);if(!(a.startsWith("http:")||a.startsWith("https:")))throw Error(`Invalid deployment address: Must start with "https://" or "http://". Found "${a}".`);try{new URL(a)}catch{throw Error(`Invalid deployment address: "${a}" is not a valid URL. If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}if(a.endsWith(".convex.site"))throw Error(`Invalid deployment address: "${a}" ends with .convex.site, which is used for HTTP Actions. Convex deployment URLs typically end with .convex.cloud? If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}function q(a){let b="object"==typeof a,c=Object.getPrototypeOf(a),d=null===c||c===Object.prototype||c?.constructor?.name==="Object";return b&&d}e[45]=62,e[95]=63,a.s(["byteLength",()=>k,"fromByteArray",()=>m,"fromByteArrayUrlSafeNoPadding",()=>n,"toByteArray",()=>l],68517),a.s(["isSimpleObject",()=>q,"parseArgs",()=>o,"validateDeploymentUrl",()=>p],10092);let r=BigInt("-9223372036854775808"),s=BigInt("9223372036854775807"),t=BigInt("0"),u=BigInt("8"),v=BigInt("256");function w(a){return Number.isNaN(a)||!Number.isFinite(a)||Object.is(a,-0)}let x=DataView.prototype.setBigInt64?function(a){if(a<r||s<a)throw Error(`BigInt ${a} does not fit into a 64-bit signed integer.`);let b=new ArrayBuffer(8);return new DataView(b).setBigInt64(0,a,!0),m(new Uint8Array(b))}:function(a){a<t&&(a-=r+r);let b=a.toString(16);b.length%2==1&&(b="0"+b);let c=new Uint8Array(new ArrayBuffer(8)),d=0;for(let e of b.match(/.{2}/g).reverse())c.set([parseInt(e,16)],d++),a>>=u;return m(c)},y=DataView.prototype.getBigInt64?function(a){let b=l(a);if(8!==b.byteLength)throw Error(`Received ${b.byteLength} bytes, expected 8 for $integer`);return new DataView(b.buffer).getBigInt64(0,!0)}:function(a){let b=l(a);if(8!==b.byteLength)throw Error(`Received ${b.byteLength} bytes, expected 8 for $integer`);let c=t,d=t;for(let a of b)c+=BigInt(a)*v**d,d++;return c>s&&(c+=r+r),c};function z(a){if(a.length>1024)throw Error(`Field name ${a} exceeds maximum field name length 1024.`);if(a.startsWith("$"))throw Error(`Field name ${a} starts with a '$', which is reserved.`);for(let b=0;b<a.length;b+=1){let c=a.charCodeAt(b);if(c<32||c>=127)throw Error(`Field name ${a} has invalid character '${a[b]}': Field names can only contain non-control ASCII characters`)}}function A(a){let b=JSON.stringify(a,(a,b)=>void 0===b?"undefined":"bigint"==typeof b?`${b.toString()}n`:b);if(b.length>16384){let a="[...truncated]",c=16384-a.length,d=b.codePointAt(c-1);return void 0!==d&&d>65535&&(c-=1),b.substring(0,c)+a}return b}function B(a,b,c,d){return a?`${b}${A(c)} is not a supported Convex type (present at path ${a} in original object ${A(d)}). To learn about Convex's supported types, see https://docs.convex.dev/using/types.`:`${b}${A(c)} is not a supported Convex type.`}function C(a){return function a(b,c,d,e){if(void 0===b){let a=d&&` (present at path ${d} in original object ${A(c)})`;throw Error(`undefined is not a valid Convex value${a}. To learn about Convex's supported types, see https://docs.convex.dev/using/types.`)}if(null===b)return b;if("bigint"==typeof b){if(b<r||s<b)throw Error(`BigInt ${b} does not fit into a 64-bit signed integer.`);return{$integer:x(b)}}if("number"==typeof b)if(!w(b))return b;else{let a=new ArrayBuffer(8);return new DataView(a).setFloat64(0,b,!0),{$float:m(new Uint8Array(a))}}if("boolean"==typeof b||"string"==typeof b)return b;if(b instanceof ArrayBuffer)return{$bytes:m(new Uint8Array(b))};if(Array.isArray(b))return b.map((b,e)=>a(b,c,d+`[${e}]`,!1));if(b instanceof Set)throw Error(B(d,"Set",[...b],c));if(b instanceof Map)throw Error(B(d,"Map",[...b],c));if(!q(b)){let a=b?.constructor?.name;throw Error(B(d,a?`${a} `:"",b,c))}let f={},g=Object.entries(b);for(let[b,h]of(g.sort(([a,b],[c,d])=>a===c?0:a<c?-1:1),g))void 0!==h?(z(b),f[b]=a(h,c,d+`.${b}`,!1)):e&&(z(b),f[b]=function(b,c,d){if(void 0===b)return{$undefined:null};if(void 0===c)throw Error(`Programming error. Current value is ${A(b)} but original value is undefined`);return a(b,c,d,!1)}(h,c,d+`.${b}`));return f}(a,a,"",!1)}a.s(["convexToJson",()=>C,"jsonToConvex",()=>function a(b){if(null===b||"boolean"==typeof b||"number"==typeof b||"string"==typeof b)return b;if(Array.isArray(b))return b.map(b=>a(b));if("object"!=typeof b)throw Error(`Unexpected type of ${b}`);let c=Object.entries(b);if(1===c.length){let a=c[0][0];if("$bytes"===a){if("string"!=typeof b.$bytes)throw Error(`Malformed $bytes field on ${b}`);return l(b.$bytes).buffer}if("$integer"===a){if("string"!=typeof b.$integer)throw Error(`Malformed $integer field on ${b}`);return y(b.$integer)}if("$float"===a){if("string"!=typeof b.$float)throw Error(`Malformed $float field on ${b}`);let a=l(b.$float);if(8!==a.byteLength)throw Error(`Received ${a.byteLength} bytes, expected 8 for $float`);let c=new DataView(a.buffer).getFloat64(0,!0);if(!w(c))throw Error(`Float ${c} should be encoded as a number`);return c}if("$set"===a)throw Error("Received a Set which is no longer supported as a Convex type.");if("$map"===a)throw Error("Received a Map which is no longer supported as a Convex type.")}let d={};for(let[c,e]of Object.entries(b))z(c),d[c]=a(e);return d},"stringifyValueForError",()=>A],59230);a.i(68517);var D=Object.defineProperty,E=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?D(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};let F=Symbol.for("ConvexError");class G extends(c=Error,b=F,c){constructor(a){super("string"==typeof a?a:A(a)),E(this,"name","ConvexError"),E(this,"data"),E(this,b,!0),this.data=a}}a.s(["ConvexError",()=>G],95487);let H=()=>Array.from({length:4},()=>0);H(),H(),a.s([],81773),a.s([],21338)},46727,9075,8914,54662,89311,a=>{"use strict";let b;var c=a.i(50527);a.i(21338);var d=a.i(59230),e=Object.defineProperty,f=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?e(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};function g(a){switch(a){case"query":return"Q";case"mutation":return"M";case"action":return"A";case"any":return"?"}}class h{constructor(a){f(this,"_onLogLineFuncs"),f(this,"_verbose"),this._onLogLineFuncs={},this._verbose=a.verbose}addLogLineListener(a){let b=Math.random().toString(36).substring(2,15);for(let a=0;a<10&&void 0!==this._onLogLineFuncs[b];a++)b=Math.random().toString(36).substring(2,15);return this._onLogLineFuncs[b]=a,()=>{delete this._onLogLineFuncs[b]}}logVerbose(...a){if(this._verbose)for(let b of Object.values(this._onLogLineFuncs))b("debug",`${new Date().toISOString()}`,...a)}log(...a){for(let b of Object.values(this._onLogLineFuncs))b("info",...a)}warn(...a){for(let b of Object.values(this._onLogLineFuncs))b("warn",...a)}error(...a){for(let b of Object.values(this._onLogLineFuncs))b("error",...a)}}function i(a){let b=new h(a);return b.addLogLineListener((a,...b)=>{switch(a){case"debug":console.debug(...b);break;case"info":default:console.log(...b);break;case"warn":console.warn(...b);break;case"error":console.error(...b)}}),b}function j(a){return new h(a)}function k(a,b,c,d,e){let f=g(c);if("object"==typeof e&&(e=`ConvexError ${JSON.stringify(e.errorData,null,2)}`),"info"===b){let b=e.match(/^\[.*?\] /);if(null===b)return void a.error(`[CONVEX ${f}(${d})] Could not parse console.log`);let c=e.slice(1,b[0].length-2),g=e.slice(b[0].length);a.log(`%c[CONVEX ${f}(${d})] [${c}]`,"color:rgb(0, 145, 255)",g)}else a.error(`[CONVEX ${f}(${d})] ${e}`)}function l(a,b){let c=`[CONVEX FATAL ERROR] ${b}`;return a.error(c),Error(c)}function m(a,b,c){let d=g(a);return`[CONVEX ${d}(${b})] ${c.errorMessage}
  Called by client`}function n(a,b){return b.data=a.errorData,b}function o(a){let b,c,d=a.split(":");return 1===d.length?(b=d[0],c="default"):(b=d.slice(0,d.length-1).join(":"),c=d[d.length-1]),b.endsWith(".js")&&(b=b.slice(0,-3)),`${b}:${c}`}function p(a,b){return JSON.stringify({udfPath:o(a),args:(0,d.convexToJson)(b)})}function q(a,b,c){let{initialNumItems:e,id:f}=c;return JSON.stringify({type:"paginated",udfPath:o(a),args:(0,d.convexToJson)(b),options:(0,d.convexToJson)({initialNumItems:e,id:f})})}function r(a){return"paginated"===JSON.parse(a).type}a.s(["createHybridErrorStacktrace",()=>m,"forwardData",()=>n,"instantiateDefaultLogger",()=>i,"instantiateNoopLogger",()=>j,"logFatalError",()=>l,"logForFunction",()=>k],9075),a.s(["canonicalizeUdfPath",()=>o,"serializePaginatedPathAndArgs",()=>q,"serializePathAndArgs",()=>p,"serializedQueryTokenIsPaginated",()=>r],8914);var s=Object.defineProperty,t=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?s(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};class u{constructor(){t(this,"nextQueryId"),t(this,"querySetVersion"),t(this,"querySet"),t(this,"queryIdToToken"),t(this,"identityVersion"),t(this,"auth"),t(this,"outstandingQueriesOlderThanRestart"),t(this,"outstandingAuthOlderThanRestart"),t(this,"paused"),t(this,"pendingQuerySetModifications"),this.nextQueryId=0,this.querySetVersion=0,this.identityVersion=0,this.querySet=new Map,this.queryIdToToken=new Map,this.outstandingQueriesOlderThanRestart=new Set,this.outstandingAuthOlderThanRestart=!1,this.paused=!1,this.pendingQuerySetModifications=new Map}hasSyncedPastLastReconnect(){return 0===this.outstandingQueriesOlderThanRestart.size&&!this.outstandingAuthOlderThanRestart}markAuthCompletion(){this.outstandingAuthOlderThanRestart=!1}subscribe(a,b,c,e){let f=o(a),g=p(f,b),h=this.querySet.get(g);if(void 0!==h)return h.numSubscribers+=1,{queryToken:g,modification:null,unsubscribe:()=>this.removeSubscriber(g)};{let a=this.nextQueryId++;this.querySet.set(g,{id:a,canonicalizedUdfPath:f,args:b,numSubscribers:1,journal:c,componentPath:e}),this.queryIdToToken.set(a,g);let h=this.querySetVersion,i=this.querySetVersion+1,j={type:"Add",queryId:a,udfPath:f,args:[(0,d.convexToJson)(b)],journal:c,componentPath:e};return this.paused?this.pendingQuerySetModifications.set(a,j):this.querySetVersion=i,{queryToken:g,modification:{type:"ModifyQuerySet",baseVersion:h,newVersion:i,modifications:[j]},unsubscribe:()=>this.removeSubscriber(g)}}}transition(a){for(let b of a.modifications)switch(b.type){case"QueryUpdated":case"QueryFailed":{this.outstandingQueriesOlderThanRestart.delete(b.queryId);let a=b.journal;if(void 0!==a){let c=this.queryIdToToken.get(b.queryId);void 0!==c&&(this.querySet.get(c).journal=a)}break}case"QueryRemoved":this.outstandingQueriesOlderThanRestart.delete(b.queryId);break;default:throw Error(`Invalid modification ${b.type}`)}}queryId(a,b){let c=p(o(a),b),d=this.querySet.get(c);return void 0!==d?d.id:null}isCurrentOrNewerAuthVersion(a){return a>=this.identityVersion}getAuth(){return this.auth}setAuth(a){this.auth={tokenType:"User",value:a};let b=this.identityVersion;return this.paused||(this.identityVersion=b+1),{type:"Authenticate",baseVersion:b,...this.auth}}setAdminAuth(a,b){let c={tokenType:"Admin",value:a,impersonating:b};this.auth=c;let d=this.identityVersion;return this.paused||(this.identityVersion=d+1),{type:"Authenticate",baseVersion:d,...c}}clearAuth(){this.auth=void 0,this.markAuthCompletion();let a=this.identityVersion;return this.paused||(this.identityVersion=a+1),{type:"Authenticate",tokenType:"None",baseVersion:a}}hasAuth(){return!!this.auth}isNewAuth(a){return this.auth?.value!==a}queryPath(a){let b=this.queryIdToToken.get(a);return b?this.querySet.get(b).canonicalizedUdfPath:null}queryArgs(a){let b=this.queryIdToToken.get(a);return b?this.querySet.get(b).args:null}queryToken(a){return this.queryIdToToken.get(a)??null}queryJournal(a){return this.querySet.get(a)?.journal}restart(a){this.unpause(),this.outstandingQueriesOlderThanRestart.clear();let b=[];for(let c of this.querySet.values()){let e={type:"Add",queryId:c.id,udfPath:c.canonicalizedUdfPath,args:[(0,d.convexToJson)(c.args)],journal:c.journal,componentPath:c.componentPath};b.push(e),a.has(c.id)||this.outstandingQueriesOlderThanRestart.add(c.id)}this.querySetVersion=1;let c={type:"ModifyQuerySet",baseVersion:0,newVersion:1,modifications:b};if(!this.auth)return this.identityVersion=0,[c,void 0];this.outstandingAuthOlderThanRestart=!0;let e={type:"Authenticate",baseVersion:0,...this.auth};return this.identityVersion=1,[c,e]}pause(){this.paused=!0}resume(){let a=this.pendingQuerySetModifications.size>0?{type:"ModifyQuerySet",baseVersion:this.querySetVersion,newVersion:++this.querySetVersion,modifications:Array.from(this.pendingQuerySetModifications.values())}:void 0,b=void 0!==this.auth?{type:"Authenticate",baseVersion:this.identityVersion++,...this.auth}:void 0;return this.unpause(),[a,b]}unpause(){this.paused=!1,this.pendingQuerySetModifications.clear()}removeSubscriber(a){let b=this.querySet.get(a);if(b.numSubscribers>1)return b.numSubscribers-=1,null;{this.querySet.delete(a),this.queryIdToToken.delete(b.id),this.outstandingQueriesOlderThanRestart.delete(b.id);let c=this.querySetVersion,d=this.querySetVersion+1,e={type:"Remove",queryId:b.id};return this.paused?this.pendingQuerySetModifications.has(b.id)?this.pendingQuerySetModifications.delete(b.id):this.pendingQuerySetModifications.set(b.id,e):this.querySetVersion=d,{type:"ModifyQuerySet",baseVersion:c,newVersion:d,modifications:[e]}}}}var v=Object.defineProperty,w=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?v(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};class x{constructor(a,b){this.logger=a,this.markConnectionStateDirty=b,w(this,"inflightRequests"),w(this,"requestsOlderThanRestart"),w(this,"inflightMutationsCount",0),w(this,"inflightActionsCount",0),this.inflightRequests=new Map,this.requestsOlderThanRestart=new Set}request(a,b){let c=new Promise(c=>{this.inflightRequests.set(a.requestId,{message:a,status:{status:b?"Requested":"NotSent",requestedAt:new Date,onResult:c}}),"Mutation"===a.type?this.inflightMutationsCount++:"Action"===a.type&&this.inflightActionsCount++});return this.markConnectionStateDirty(),c}onResponse(a){let b,c,e=this.inflightRequests.get(a.requestId);if(void 0===e||"Completed"===e.status.status)return null;let f="Mutation"===e.message.type?"mutation":"action",g=e.message.udfPath;for(let b of a.logLines)k(this.logger,"info",f,g,b);let h=e.status;if(a.success)b={success:!0,logLines:a.logLines,value:(0,d.jsonToConvex)(a.result)},c=()=>h.onResult(b);else{let e=a.result,{errorData:i}=a;k(this.logger,"error",f,g,e),b={success:!1,errorMessage:e,errorData:void 0!==i?(0,d.jsonToConvex)(i):void 0,logLines:a.logLines},c=()=>h.onResult(b)}return"ActionResponse"!==a.type&&a.success?(e.status={status:"Completed",result:b,ts:a.ts,onResolve:c},null):(c(),this.inflightRequests.delete(a.requestId),this.requestsOlderThanRestart.delete(a.requestId),"Action"===e.message.type?this.inflightActionsCount--:"Mutation"===e.message.type&&this.inflightMutationsCount--,this.markConnectionStateDirty(),{requestId:a.requestId,result:b})}removeCompleted(a){let b=new Map;for(let[c,d]of this.inflightRequests.entries()){let e=d.status;"Completed"===e.status&&e.ts.lessThanOrEqual(a)&&(e.onResolve(),b.set(c,e.result),"Mutation"===d.message.type?this.inflightMutationsCount--:"Action"===d.message.type&&this.inflightActionsCount--,this.inflightRequests.delete(c),this.requestsOlderThanRestart.delete(c))}return b.size>0&&this.markConnectionStateDirty(),b}restart(){this.requestsOlderThanRestart=new Set(this.inflightRequests.keys());let a=[];for(let[b,c]of this.inflightRequests){if("NotSent"===c.status.status){c.status.status="Requested",a.push(c.message);continue}if("Mutation"===c.message.type)a.push(c.message);else if("Action"===c.message.type){if(this.inflightRequests.delete(b),this.requestsOlderThanRestart.delete(b),this.inflightActionsCount--,"Completed"===c.status.status)throw Error("Action should never be in 'Completed' state");c.status.onResult({success:!1,errorMessage:"Connection lost while action was in flight",logLines:[]})}}return this.markConnectionStateDirty(),a}resume(){let a=[];for(let[,b]of this.inflightRequests)if("NotSent"===b.status.status){b.status.status="Requested",a.push(b.message);continue}return a}hasIncompleteRequests(){for(let a of this.inflightRequests.values())if("Requested"===a.status.status)return!0;return!1}hasInflightRequests(){return this.inflightRequests.size>0}hasSyncedPastLastReconnect(){return 0===this.requestsOlderThanRestart.size}timeOfOldestInflightRequest(){if(0===this.inflightRequests.size)return null;let a=Date.now();for(let b of this.inflightRequests.values())"Completed"!==b.status.status&&b.status.requestedAt.getTime()<a&&(a=b.status.requestedAt.getTime());return new Date(a)}inflightMutations(){return this.inflightMutationsCount}inflightActions(){return this.inflightActionsCount}}let y=Symbol.for("functionName"),z=Symbol.for("toReferencePath");function A(a){let b=function(a){let b;if("string"==typeof a)b=a.startsWith("function://")?{functionHandle:a}:{name:a};else if(a[y])b={name:a[y]};else{let c=a[z]??null;if(!c)throw Error(`${a} is not a functionReference`);b={reference:c}}return b}(a);if(void 0===b.name){if(void 0!==b.functionHandle)throw Error(`Expected function reference like "api.file.func" or "internal.file.func", but received function handle ${b.functionHandle}`);if(void 0!==b.reference)throw Error(`Expected function reference in the current component like "api.file.func" or "internal.file.func", but received reference ${b.reference}`);throw Error(`Expected function reference like "api.file.func" or "internal.file.func", but received ${JSON.stringify(b)}`)}if("string"==typeof a)return a;let c=a[y];if(!c)throw Error(`${a} is not a functionReference`);return c}!function a(b=[]){return new Proxy({},{get(c,d){if("string"==typeof d)return a([...b,d]);if(d===y){if(b.length<2){let a=["api",...b].join(".");throw Error(`API path is expected to be of the form \`api.moduleName.functionName\`. Found: \`${a}\``)}let a=b.slice(0,-1).join("/"),c=b[b.length-1];return"default"===c?a:a+":"+c}return d===Symbol.toStringTag?"FunctionReference":void 0}})}(),a.s(["getFunctionName",()=>A],54662);var B=a.i(10092),C=a.i(95487),D=Object.defineProperty,E=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?D(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};class F{constructor(a){E(this,"queryResults"),E(this,"modifiedQueries"),this.queryResults=a,this.modifiedQueries=[]}getQuery(a,...b){let c=(0,B.parseArgs)(b[0]),d=A(a),e=this.queryResults.get(p(d,c));if(void 0!==e)return F.queryValue(e.result)}getAllQueries(a){let b=[],c=A(a);for(let a of this.queryResults.values())a.udfPath===o(c)&&b.push({args:a.args,value:F.queryValue(a.result)});return b}setQuery(a,b,c){let d=(0,B.parseArgs)(b),e=A(a),f=p(e,d);this.queryResults.set(f,{udfPath:e,args:d,result:void 0===c?void 0:{success:!0,value:c,logLines:[]}}),this.modifiedQueries.push(f)}static queryValue(a){return void 0===a?void 0:a.success?a.value:void 0}}class G{constructor(){E(this,"queryResults"),E(this,"optimisticUpdates"),this.queryResults=new Map,this.optimisticUpdates=[]}ingestQueryResultsFromServer(a,b){this.optimisticUpdates=this.optimisticUpdates.filter(a=>!b.has(a.mutationId));let c=this.queryResults;this.queryResults=new Map(a);let d=new F(this.queryResults);for(let a of this.optimisticUpdates)a.update(d);let e=[];for(let[a,b]of this.queryResults){let d=c.get(a);(void 0===d||d.result!==b.result)&&e.push(a)}return e}applyOptimisticUpdate(a,b){this.optimisticUpdates.push({update:a,mutationId:b});let c=new F(this.queryResults);return a(c),c.modifiedQueries}rawQueryResult(a){let b=this.queryResults.get(a);if(void 0!==b)return b.result}queryResult(a){let b=this.queryResults.get(a);if(void 0===b)return;let c=b.result;if(void 0!==c){if(c.success)return c.value;if(void 0!==c.errorData)throw n(c,new C.ConvexError(m("query",b.udfPath,c)));throw Error(m("query",b.udfPath,c))}}hasQueryResult(a){return void 0!==this.queryResults.get(a)}queryLogs(a){let b=this.queryResults.get(a);return b?.result?.logLines}}var H=Object.defineProperty,I=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?H(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};class J{constructor(a,b){I(this,"low"),I(this,"high"),I(this,"__isUnsignedLong__"),this.low=0|a,this.high=0|b,this.__isUnsignedLong__=!0}static isLong(a){return!0===(a&&a.__isUnsignedLong__)}static fromBytesLE(a){return new J(a[0]|a[1]<<8|a[2]<<16|a[3]<<24,a[4]|a[5]<<8|a[6]<<16|a[7]<<24)}toBytesLE(){let a=this.high,b=this.low;return[255&b,b>>>8&255,b>>>16&255,b>>>24,255&a,a>>>8&255,a>>>16&255,a>>>24]}static fromNumber(a){return isNaN(a)||a<0?K:a>=M?N:new J(a%L|0,a/L|0)}toString(){return(BigInt(this.high)*BigInt(L)+BigInt(this.low)).toString()}equals(a){return J.isLong(a)||(a=J.fromValue(a)),(this.high>>>31!=1||a.high>>>31!=1)&&this.high===a.high&&this.low===a.low}notEquals(a){return!this.equals(a)}comp(a){return(J.isLong(a)||(a=J.fromValue(a)),this.equals(a))?0:a.high>>>0>this.high>>>0||a.high===this.high&&a.low>>>0>this.low>>>0?-1:1}lessThanOrEqual(a){return 0>=this.comp(a)}static fromValue(a){return"number"==typeof a?J.fromNumber(a):new J(a.low,a.high)}}let K=new J(0,0),L=0x100000000,M=0xffffffffffffffff,N=new J(-1,-1);a.s(["Long",()=>J],89311);var O=Object.defineProperty,P=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?O(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};class Q{constructor(a,b){P(this,"version"),P(this,"remoteQuerySet"),P(this,"queryPath"),P(this,"logger"),this.version={querySet:0,ts:J.fromNumber(0),identity:0},this.remoteQuerySet=new Map,this.queryPath=a,this.logger=b}transition(a){let b=a.startVersion;if(this.version.querySet!==b.querySet||this.version.ts.notEquals(b.ts)||this.version.identity!==b.identity)throw Error(`Invalid start version: ${b.ts.toString()}:${b.querySet}:${b.identity}, transitioning from ${this.version.ts.toString()}:${this.version.querySet}:${this.version.identity}`);for(let b of a.modifications)switch(b.type){case"QueryUpdated":{let a=this.queryPath(b.queryId);if(a)for(let c of b.logLines)k(this.logger,"info","query",a,c);let c=(0,d.jsonToConvex)(b.value??null);this.remoteQuerySet.set(b.queryId,{success:!0,value:c,logLines:b.logLines});break}case"QueryFailed":{let a=this.queryPath(b.queryId);if(a)for(let c of b.logLines)k(this.logger,"info","query",a,c);let{errorData:c}=b;this.remoteQuerySet.set(b.queryId,{success:!1,errorMessage:b.errorMessage,errorData:void 0!==c?(0,d.jsonToConvex)(c):void 0,logLines:b.logLines});break}case"QueryRemoved":this.remoteQuerySet.delete(b.queryId);break;default:throw Error(`Invalid modification ${b.type}`)}this.version=a.endVersion}remoteQueryResults(){return this.remoteQuerySet}timestamp(){return this.version.ts}}var R=a.i(68517),R=R;function S(a){let b=R.toByteArray(a);return J.fromBytesLE(Array.from(b))}function T(a){switch(a.type){case"FatalError":case"AuthError":case"ActionResponse":case"TransitionChunk":case"Ping":return{...a};case"MutationResponse":if(a.success)return{...a,ts:S(a.ts)};return{...a};case"Transition":return{...a,startVersion:{...a.startVersion,ts:S(a.startVersion.ts)},endVersion:{...a.endVersion,ts:S(a.endVersion.ts)}}}}var U=Object.defineProperty,V=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?U(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};function W(){return(void 0===b&&(b=Date.now()),"undefined"!=typeof performance&&performance.now)?Math.round(b+performance.now()):Date.now()}function X(){return`t=${Math.round((W()-b)/100)/10}s`}let Y={InternalServerError:{timeout:1e3},SubscriptionsWorkerFullError:{timeout:3e3},TooManyConcurrentRequests:{timeout:3e3},CommitterFullError:{timeout:3e3},AwsTooManyRequestsException:{timeout:3e3},ExecuteFullError:{timeout:3e3},SystemTimeoutError:{timeout:3e3},ExpiredInQueue:{timeout:3e3},VectorIndexesUnavailable:{timeout:1e3},SearchIndexesUnavailable:{timeout:1e3},TableSummariesUnavailable:{timeout:1e3},VectorIndexTooLarge:{timeout:3e3},SearchIndexTooLarge:{timeout:3e3},TooManyWritesInTimePeriod:{timeout:3e3}};class Z{constructor(a,b,c,d,e,f){this.markConnectionStateDirty=e,this.debug=f,V(this,"socket"),V(this,"connectionCount"),V(this,"_hasEverConnected",!1),V(this,"lastCloseReason"),V(this,"transitionChunkBuffer",null),V(this,"defaultInitialBackoff"),V(this,"maxBackoff"),V(this,"retries"),V(this,"serverInactivityThreshold"),V(this,"reconnectDueToServerInactivityTimeout"),V(this,"scheduledReconnect",null),V(this,"networkOnlineHandler",null),V(this,"pendingNetworkRecoveryInfo",null),V(this,"uri"),V(this,"onOpen"),V(this,"onResume"),V(this,"onMessage"),V(this,"webSocketConstructor"),V(this,"logger"),V(this,"onServerDisconnectError"),this.webSocketConstructor=c,this.socket={state:"disconnected"},this.connectionCount=0,this.lastCloseReason="InitialConnect",this.defaultInitialBackoff=1e3,this.maxBackoff=16e3,this.retries=0,this.serverInactivityThreshold=6e4,this.reconnectDueToServerInactivityTimeout=null,this.uri=a,this.onOpen=b.onOpen,this.onResume=b.onResume,this.onMessage=b.onMessage,this.onServerDisconnectError=b.onServerDisconnectError,this.logger=d,this.setupNetworkListener(),this.connect()}setSocketState(a){this.socket=a,this._logVerbose(`socket state changed: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}`),this.markConnectionStateDirty()}setupNetworkListener(){}cleanupNetworkListener(){this.networkOnlineHandler}assembleTransition(a){if(a.partNumber<0||a.partNumber>=a.totalParts||0===a.totalParts||this.transitionChunkBuffer&&(this.transitionChunkBuffer.totalParts!==a.totalParts||this.transitionChunkBuffer.transitionId!==a.transitionId))throw this.transitionChunkBuffer=null,Error("Invalid TransitionChunk");if(null===this.transitionChunkBuffer&&(this.transitionChunkBuffer={chunks:[],totalParts:a.totalParts,transitionId:a.transitionId}),a.partNumber!==this.transitionChunkBuffer.chunks.length){let b=this.transitionChunkBuffer.chunks.length;throw this.transitionChunkBuffer=null,Error(`TransitionChunk received out of order: expected part ${b}, got ${a.partNumber}`)}if(this.transitionChunkBuffer.chunks.push(a.chunk),this.transitionChunkBuffer.chunks.length===a.totalParts){let a=this.transitionChunkBuffer.chunks.join("");this.transitionChunkBuffer=null;let b=T(JSON.parse(a));if("Transition"!==b.type)throw Error(`Expected Transition, got ${b.type} after assembling chunks`);return b}return null}connect(){if("terminated"===this.socket.state)return;if("disconnected"!==this.socket.state&&"stopped"!==this.socket.state)throw Error("Didn't start connection from disconnected state: "+this.socket.state);let a=new this.webSocketConstructor(this.uri);this._logVerbose("constructed WebSocket"),this.setSocketState({state:"connecting",ws:a,paused:"no"}),this.resetServerInactivityTimeout(),a.onopen=()=>{if(this.logger.logVerbose("begin ws.onopen"),"connecting"!==this.socket.state)throw Error("onopen called with socket not in connecting state");if(this.setSocketState({state:"ready",ws:a,paused:"yes"===this.socket.paused?"uninitialized":"no"}),this.resetServerInactivityTimeout(),"no"===this.socket.paused&&(this._hasEverConnected=!0,this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason,clientTs:W()})),"InitialConnect"!==this.lastCloseReason&&(this.lastCloseReason?this.logger.log("WebSocket reconnected at",X(),"after disconnect due to",this.lastCloseReason):this.logger.log("WebSocket reconnected at",X())),this.connectionCount+=1,this.lastCloseReason=null,null!==this.pendingNetworkRecoveryInfo){let{timeSavedMs:a}=this.pendingNetworkRecoveryInfo;this.pendingNetworkRecoveryInfo=null,this.sendMessage({type:"Event",eventType:"NetworkRecoveryReconnect",event:{timeSavedMs:a}}),this.logger.log(`Network recovery reconnect saved ~${Math.round(a/1e3)}s of waiting`)}},a.onerror=a=>{this.transitionChunkBuffer=null;let b=a.message;b&&this.logger.log(`WebSocket error message: ${b}`)},a.onmessage=a=>{this.resetServerInactivityTimeout();let b=a.data.length,c=T(JSON.parse(a.data));if(this._logVerbose(`received ws message with type ${c.type}`),"Ping"!==c.type){if("TransitionChunk"===c.type){let a=this.assembleTransition(c);if(!a)return;c=a,this._logVerbose(`assembled full ws message of type ${c.type}`)}null!==this.transitionChunkBuffer&&(this.transitionChunkBuffer=null,this.logger.log(`Received unexpected ${c.type} while buffering TransitionChunks`)),"Transition"===c.type&&this.reportLargeTransition({messageLength:b,transition:c}),this.onMessage(c).hasSyncedPastLastReconnect&&(this.retries=0,this.markConnectionStateDirty())}},a.onclose=a=>{if(this._logVerbose("begin ws.onclose"),this.transitionChunkBuffer=null,null===this.lastCloseReason&&(this.lastCloseReason=a.reason||`closed with code ${a.code}`),1e3!==a.code&&1001!==a.code&&1005!==a.code&&4040!==a.code){let b=`WebSocket closed with code ${a.code}`;a.reason&&(b+=`: ${a.reason}`),this.logger.log(b),this.onServerDisconnectError&&a.reason&&this.onServerDisconnectError(b)}let b=function(a){if(void 0===a)return"Unknown";for(let b of Object.keys(Y))if(a.startsWith(b))return b;return"Unknown"}(a.reason);this.scheduleReconnect(b)}}socketState(){return this.socket.state}sendMessage(a){let b={type:a.type,..."Authenticate"===a.type&&"User"===a.tokenType?{value:`...${a.value.slice(-7)}`}:{}};if("ready"===this.socket.state&&"no"===this.socket.paused){let c=JSON.stringify(function(a){switch(a.type){case"Authenticate":case"ModifyQuerySet":case"Mutation":case"Action":case"Event":return{...a};case"Connect":let b;if(void 0===a.maxObservedTimestamp)return{...a,maxObservedTimestamp:void 0};return{...a,maxObservedTimestamp:(b=new Uint8Array(a.maxObservedTimestamp.toBytesLE()),R.fromByteArray(b))}}}(a)),d=!1;try{this.socket.ws.send(c),d=!0}catch(a){this.logger.log(`Failed to send message on WebSocket, reconnecting: ${a}`),this.closeAndReconnect("FailedToSendMessage")}return this._logVerbose(`${d?"sent":"failed to send"} message with type ${a.type}: ${JSON.stringify(b)}`),!0}return this._logVerbose(`message not sent (socket state: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}): ${JSON.stringify(b)}`),!1}resetServerInactivityTimeout(){"terminated"!==this.socket.state&&(null!==this.reconnectDueToServerInactivityTimeout&&(clearTimeout(this.reconnectDueToServerInactivityTimeout),this.reconnectDueToServerInactivityTimeout=null),this.reconnectDueToServerInactivityTimeout=setTimeout(()=>{this.closeAndReconnect("InactiveServer")},this.serverInactivityThreshold))}scheduleReconnect(a){this.scheduledReconnect&&(clearTimeout(this.scheduledReconnect.timeout),this.scheduledReconnect=null),this.socket={state:"disconnected"};let b=this.nextBackoff(a);this.markConnectionStateDirty(),this.logger.log(`Attempting reconnect in ${Math.round(b)}ms`);let c=W(),d=setTimeout(()=>{this.scheduledReconnect?.timeout===d&&(this.scheduledReconnect=null,this.connect())},b);this.scheduledReconnect={timeout:d,scheduledAt:c,backoffMs:b}}closeAndReconnect(a){switch(this._logVerbose(`begin closeAndReconnect with reason ${a}`),this.socket.state){case"disconnected":case"terminated":case"stopped":return;case"connecting":case"ready":this.lastCloseReason=a,this.close(),this.scheduleReconnect("client");return;default:this.socket}}close(){switch(this.transitionChunkBuffer=null,this.socket.state){case"disconnected":case"terminated":case"stopped":return Promise.resolve();case"connecting":{let a=this.socket.ws;return a.onmessage=a=>{this._logVerbose("Ignoring message received after close")},new Promise(b=>{a.onclose=()=>{this._logVerbose("Closed after connecting"),b()},a.onopen=()=>{this._logVerbose("Opened after connecting"),a.close()}})}case"ready":{this._logVerbose("ws.close called");let a=this.socket.ws;a.onmessage=a=>{this._logVerbose("Ignoring message received after close")};let b=new Promise(b=>{a.onclose=()=>{b()}});return a.close(),b}default:return this.socket,Promise.resolve()}}terminate(){switch(this.reconnectDueToServerInactivityTimeout&&clearTimeout(this.reconnectDueToServerInactivityTimeout),this.scheduledReconnect&&(clearTimeout(this.scheduledReconnect.timeout),this.scheduledReconnect=null),this.cleanupNetworkListener(),this.socket.state){case"terminated":case"stopped":case"disconnected":case"connecting":case"ready":{let a=this.close();return this.setSocketState({state:"terminated"}),a}default:throw this.socket,Error(`Invalid websocket state: ${this.socket.state}`)}}stop(){switch(this.socket.state){case"terminated":return Promise.resolve();case"connecting":case"stopped":case"disconnected":case"ready":{this.cleanupNetworkListener();let a=this.close();return this.socket={state:"stopped"},a}default:return this.socket,Promise.resolve()}}tryRestart(){switch(this.socket.state){case"stopped":break;case"terminated":case"connecting":case"ready":case"disconnected":this.logger.logVerbose("Restart called without stopping first");return;default:this.socket}this.setupNetworkListener(),this.connect()}pause(){switch(this.socket.state){case"disconnected":case"stopped":case"terminated":return;case"connecting":case"ready":this.socket={...this.socket,paused:"yes"};return;default:return void this.socket}}tryReconnectImmediately(){if(this._logVerbose("tryReconnectImmediately called"),"disconnected"!==this.socket.state)return void this._logVerbose(`tryReconnectImmediately called but socket state is ${this.socket.state}, no action taken`);let a=null;if(this.scheduledReconnect){let b=W()-this.scheduledReconnect.scheduledAt;a=Math.max(0,this.scheduledReconnect.backoffMs-b),this._logVerbose(`would have waited ${Math.round(a)}ms more (backoff was ${Math.round(this.scheduledReconnect.backoffMs)}ms, elapsed ${Math.round(b)}ms)`),clearTimeout(this.scheduledReconnect.timeout),this.scheduledReconnect=null,this._logVerbose("canceled scheduled reconnect")}this.logger.log("Network recovery detected, reconnecting immediately"),this.pendingNetworkRecoveryInfo=null!==a?{timeSavedMs:a}:null,this.connect()}resume(){switch(this.socket.state){case"connecting":this.socket={...this.socket,paused:"no"};return;case"ready":"uninitialized"===this.socket.paused?(this.socket={...this.socket,paused:"no"},this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason,clientTs:W()})):"yes"===this.socket.paused&&(this.socket={...this.socket,paused:"no"},this.onResume());return;case"terminated":case"stopped":case"disconnected":return;default:this.socket}this.connect()}connectionState(){return{isConnected:"ready"===this.socket.state,hasEverConnected:this._hasEverConnected,connectionCount:this.connectionCount,connectionRetries:this.retries}}_logVerbose(a){this.logger.logVerbose(a)}nextBackoff(a){let b=("client"===a?100:"Unknown"===a?this.defaultInitialBackoff:Y[a].timeout)*Math.pow(2,this.retries);this.retries+=1;let c=Math.min(b,this.maxBackoff),d=c*(Math.random()-.5);return c+d}reportLargeTransition({transition:a,messageLength:b}){if(void 0===a.clientClockSkew||void 0===a.serverTs)return;let c=W()-a.clientClockSkew-a.serverTs/1e6,d=`${Math.round(c)}ms`,e=`${Math.round(b/1e4)/100}MB`,f=b/(c/1e3),g=`${Math.round(f/1e4)/100}MB per second`;this._logVerbose(`received ${e} transition in ${d} at ${g}`),b>2e7?this.logger.log(`received query results totaling more that 20MB (${e}) which will take a long time to download on slower connections`):c>2e4&&this.logger.log(`received query results totaling ${e} which took more than 20s to arrive (${d})`),this.debug&&this.sendMessage({type:"Event",eventType:"ClientReceivedTransition",event:{transitionTransitTime:c,messageLength:b}})}}class $ extends Error{}function _(a,b){let c;if("string"!=typeof a)throw new $("Invalid token specified: must be a string");b||(b={});let d=+(!0!==b.header),e=a.split(".")[d];if("string"!=typeof e)throw new $(`Invalid token specified: missing part #${d+1}`);try{c=function(a){let b=a.replace(/-/g,"+").replace(/_/g,"/");switch(b.length%4){case 0:break;case 2:b+="==";break;case 3:b+="=";break;default:throw Error("base64 string is not of the correct length")}try{var c;return c=b,decodeURIComponent(atob(c).replace(/(.)/g,(a,b)=>{let c=b.charCodeAt(0).toString(16).toUpperCase();return c.length<2&&(c="0"+c),"%"+c}))}catch{return atob(b)}}(e)}catch(a){throw new $(`Invalid token specified: invalid base64 for part #${d+1} (${a.message})`)}try{return JSON.parse(c)}catch(a){throw new $(`Invalid token specified: invalid json for part #${d+1} (${a.message})`)}}$.prototype.name="InvalidTokenError";var aa=Object.defineProperty,ab=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?aa(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};class ac{constructor(a,b,c){ab(this,"authState",{state:"noAuth"}),ab(this,"configVersion",0),ab(this,"syncState"),ab(this,"authenticate"),ab(this,"stopSocket"),ab(this,"tryRestartSocket"),ab(this,"pauseSocket"),ab(this,"resumeSocket"),ab(this,"clearAuth"),ab(this,"logger"),ab(this,"refreshTokenLeewaySeconds"),ab(this,"tokenConfirmationAttempts",0),this.syncState=a,this.authenticate=b.authenticate,this.stopSocket=b.stopSocket,this.tryRestartSocket=b.tryRestartSocket,this.pauseSocket=b.pauseSocket,this.resumeSocket=b.resumeSocket,this.clearAuth=b.clearAuth,this.logger=c.logger,this.refreshTokenLeewaySeconds=c.refreshTokenLeewaySeconds}async setConfig(a,b){this.resetAuthState(),this._logVerbose("pausing WS for auth token fetch"),this.pauseSocket();let c=await this.fetchTokenAndGuardAgainstRace(a,{forceRefreshToken:!1});c.isFromOutdatedConfig||(c.value?(this.setAuthState({state:"waitingForServerConfirmationOfCachedToken",config:{fetchToken:a,onAuthChange:b},hasRetried:!1}),this.authenticate(c.value)):(this.setAuthState({state:"initialRefetch",config:{fetchToken:a,onAuthChange:b}}),await this.refetchToken()),this._logVerbose("resuming WS after auth token fetch"),this.resumeSocket())}onTransition(a){if(this.syncState.isCurrentOrNewerAuthVersion(a.endVersion.identity)&&!(a.endVersion.identity<=a.startVersion.identity)){if("waitingForServerConfirmationOfCachedToken"===this.authState.state){this._logVerbose("server confirmed auth token is valid"),this.refetchToken(),this.authState.config.onAuthChange(!0);return}"waitingForServerConfirmationOfFreshToken"===this.authState.state&&(this._logVerbose("server confirmed new auth token is valid"),this.scheduleTokenRefetch(this.authState.token),this.tokenConfirmationAttempts=0,this.authState.hadAuth||this.authState.config.onAuthChange(!0))}}onAuthError(a){if(!1===a.authUpdateAttempted&&("waitingForServerConfirmationOfFreshToken"===this.authState.state||"waitingForServerConfirmationOfCachedToken"===this.authState.state))return void this._logVerbose("ignoring non-auth token expired error");let{baseVersion:b}=a;this.syncState.isCurrentOrNewerAuthVersion(b+1)?this.tryToReauthenticate(a):this._logVerbose("ignoring auth error for previous auth attempt")}async tryToReauthenticate(a){if(this._logVerbose(`attempting to reauthenticate: ${a.error}`),"noAuth"===this.authState.state||"waitingForServerConfirmationOfFreshToken"===this.authState.state&&this.tokenConfirmationAttempts>=2){this.logger.error(`Failed to authenticate: "${a.error}", check your server auth config`),this.syncState.hasAuth()&&this.syncState.clearAuth(),"noAuth"!==this.authState.state&&this.setAndReportAuthFailed(this.authState.config.onAuthChange);return}"waitingForServerConfirmationOfFreshToken"===this.authState.state&&(this.tokenConfirmationAttempts++,this._logVerbose(`retrying reauthentication, ${2-this.tokenConfirmationAttempts} attempts remaining`)),await this.stopSocket();let b=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});b.isFromOutdatedConfig||(b.value&&this.syncState.isNewAuth(b.value)?(this.authenticate(b.value),this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",config:this.authState.config,token:b.value,hadAuth:"notRefetching"===this.authState.state||"waitingForScheduledRefetch"===this.authState.state})):(this._logVerbose("reauthentication failed, could not fetch a new token"),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this.tryRestartSocket())}async refetchToken(){if("noAuth"===this.authState.state)return;this._logVerbose("refetching auth token");let a=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});a.isFromOutdatedConfig||(a.value?this.syncState.isNewAuth(a.value)?(this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",hadAuth:this.syncState.hasAuth(),token:a.value,config:this.authState.config}),this.authenticate(a.value)):this.setAuthState({state:"notRefetching",config:this.authState.config}):(this._logVerbose("refetching token failed"),this.syncState.hasAuth()&&this.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this._logVerbose("restarting WS after auth token fetch (if currently stopped)"),this.tryRestartSocket())}scheduleTokenRefetch(a){if("noAuth"===this.authState.state)return;let b=this.decodeToken(a);if(!b)return void this.logger.error("Auth token is not a valid JWT, cannot refetch the token");let{iat:c,exp:d}=b;if(!c||!d)return void this.logger.error("Auth token does not have required fields, cannot refetch the token");let e=d-c;if(e<=2)return void this.logger.error("Auth token does not live long enough, cannot refetch the token");let f=Math.min(1728e6,(e-this.refreshTokenLeewaySeconds)*1e3);f<=0&&(this.logger.warn(`Refetching auth token immediately, configured leeway ${this.refreshTokenLeewaySeconds}s is larger than the token's lifetime ${e}s`),f=0);let g=setTimeout(()=>{this._logVerbose("running scheduled token refetch"),this.refetchToken()},f);this.setAuthState({state:"waitingForScheduledRefetch",refetchTokenTimeoutId:g,config:this.authState.config}),this._logVerbose(`scheduled preemptive auth token refetching in ${f}ms`)}async fetchTokenAndGuardAgainstRace(a,b){let c=++this.configVersion;this._logVerbose(`fetching token with config version ${c}`);let d=await a(b);return this.configVersion!==c?(this._logVerbose(`stale config version, expected ${c}, got ${this.configVersion}`),{isFromOutdatedConfig:!0}):{isFromOutdatedConfig:!1,value:d}}stop(){this.resetAuthState(),this.configVersion++,this._logVerbose(`config version bumped to ${this.configVersion}`)}setAndReportAuthFailed(a){a(!1),this.resetAuthState()}resetAuthState(){this.setAuthState({state:"noAuth"})}setAuthState(a){let b="waitingForServerConfirmationOfFreshToken"===a.state?{hadAuth:a.hadAuth,state:a.state,token:`...${a.token.slice(-7)}`}:{state:a.state};switch(this._logVerbose(`setting auth state to ${JSON.stringify(b)}`),a.state){case"waitingForScheduledRefetch":case"notRefetching":case"noAuth":this.tokenConfirmationAttempts=0}"waitingForScheduledRefetch"===this.authState.state&&(clearTimeout(this.authState.refetchTokenTimeoutId),this.syncState.markAuthCompletion()),this.authState=a}decodeToken(a){try{return _(a)}catch(a){return this._logVerbose(`Error decoding token: ${a instanceof Error?a.message:"Unknown error"}`),null}}_logVerbose(a){this.logger.logVerbose(`${a} [v${this.configVersion}]`)}}let ad=["convexClientConstructed","convexWebSocketOpen","convexFirstMessageReceived"];function ae(a){let b=a.name.slice(6);return{name:b=b.charAt(0).toLowerCase()+b.slice(1),startTime:a.startTime}}var af=Object.defineProperty,ag=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?af(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};class ah{constructor(a,b,d){let e;if(ag(this,"address"),ag(this,"state"),ag(this,"requestManager"),ag(this,"webSocketManager"),ag(this,"authenticationManager"),ag(this,"remoteQuerySet"),ag(this,"optimisticQueryResults"),ag(this,"_transitionHandlerCounter",0),ag(this,"_nextRequestId"),ag(this,"_onTransitionFns",new Map),ag(this,"_sessionId"),ag(this,"firstMessageReceived",!1),ag(this,"debug"),ag(this,"logger"),ag(this,"maxObservedTimestamp"),ag(this,"connectionStateSubscribers",new Map),ag(this,"nextConnectionStateSubscriberId",0),ag(this,"_lastPublishedConnectionState"),ag(this,"markConnectionStateDirty",()=>{Promise.resolve().then(()=>{let a=this.connectionState();if(JSON.stringify(a)!==JSON.stringify(this._lastPublishedConnectionState))for(let b of(this._lastPublishedConnectionState=a,this.connectionStateSubscribers.values()))b(a)})}),ag(this,"mark",a=>{var b;this.debug&&(b=this.sessionId,"undefined"!=typeof performance&&performance.mark&&performance.mark(a,{detail:{sessionId:b}}))}),"object"==typeof a)throw Error("Passing a ClientConfig object is no longer supported. Pass the URL of the Convex deployment as a string directly.");d?.skipConvexDeploymentUrlCheck!==!0&&(0,B.validateDeploymentUrl)(a);const f=(d={...d}).authRefreshTokenLeewaySeconds??2;let g=d.webSocketConstructor;if(!g&&"undefined"==typeof WebSocket)throw Error("No WebSocket global variable defined! To use Convex in an environment without WebSocket try the HTTP client: https://docs.convex.dev/api/classes/browser.ConvexHttpClient");g=g||WebSocket,this.debug=d.reportDebugInfoToConvex??!1,this.address=a,this.logger=!1===d.logger?j({verbose:d.verbose??!1}):!0!==d.logger&&d.logger?d.logger:i({verbose:d.verbose??!1});const h=a.search("://");if(-1===h)throw Error("Provided address was not an absolute URL.");const k=a.substring(h+3),m=a.substring(0,h);if("http"===m)e="ws";else if("https"===m)e="wss";else throw Error(`Unknown parent protocol ${m}`);const n=`${e}://${k}/api/${c.version}/sync`;this.state=new u,this.remoteQuerySet=new Q(a=>this.state.queryPath(a),this.logger),this.requestManager=new x(this.logger,this.markConnectionStateDirty);const o=()=>{this.webSocketManager.pause(),this.state.pause()};this.authenticationManager=new ac(this.state,{authenticate:a=>{let b=this.state.setAuth(a);return this.webSocketManager.sendMessage(b),b.baseVersion},stopSocket:()=>this.webSocketManager.stop(),tryRestartSocket:()=>this.webSocketManager.tryRestart(),pauseSocket:o,resumeSocket:()=>this.webSocketManager.resume(),clearAuth:()=>{this.clearAuth()}},{logger:this.logger,refreshTokenLeewaySeconds:f}),this.optimisticQueryResults=new G,this.addOnTransitionHandler(a=>{b(a.queries.map(a=>a.token))}),this._nextRequestId=0,this._sessionId="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let b=16*Math.random()|0;return("x"===a?b:3&b|8).toString(16)});const{unsavedChangesWarning:p}=d;if(!0===p)throw Error("unsavedChangesWarning requested, but window.addEventListener not found! Remove {unsavedChangesWarning: true} from Convex client options.");this.webSocketManager=new Z(n,{onOpen:a=>{this.mark("convexWebSocketOpen"),this.webSocketManager.sendMessage({...a,type:"Connect",sessionId:this._sessionId,maxObservedTimestamp:this.maxObservedTimestamp});let b=new Set(this.remoteQuerySet.remoteQueryResults().keys());this.remoteQuerySet=new Q(a=>this.state.queryPath(a),this.logger);let[c,d]=this.state.restart(b);for(let a of(d&&this.webSocketManager.sendMessage(d),this.webSocketManager.sendMessage(c),this.requestManager.restart()))this.webSocketManager.sendMessage(a)},onResume:()=>{let[a,b]=this.state.resume();for(let c of(b&&this.webSocketManager.sendMessage(b),a&&this.webSocketManager.sendMessage(a),this.requestManager.resume()))this.webSocketManager.sendMessage(c)},onMessage:a=>{switch(!this.firstMessageReceived&&(this.firstMessageReceived=!0,this.mark("convexFirstMessageReceived"),this.reportMarks()),a.type){case"Transition":{this.observedTimestamp(a.endVersion.ts),this.authenticationManager.onTransition(a),this.remoteQuerySet.transition(a),this.state.transition(a);let b=this.requestManager.removeCompleted(this.remoteQuerySet.timestamp());this.notifyOnQueryResultChanges(b);break}case"MutationResponse":{a.success&&this.observedTimestamp(a.ts);let b=this.requestManager.onResponse(a);null!==b&&this.notifyOnQueryResultChanges(new Map([[b.requestId,b.result]]));break}case"ActionResponse":this.requestManager.onResponse(a);break;case"AuthError":this.authenticationManager.onAuthError(a);break;case"FatalError":{let b=l(this.logger,a.error);throw this.webSocketManager.terminate(),b}}return{hasSyncedPastLastReconnect:this.hasSyncedPastLastReconnect()}},onServerDisconnectError:d.onServerDisconnectError},g,this.logger,this.markConnectionStateDirty,this.debug),this.mark("convexClientConstructed"),d.expectAuth&&o()}hasSyncedPastLastReconnect(){return this.requestManager.hasSyncedPastLastReconnect()||this.state.hasSyncedPastLastReconnect()}observedTimestamp(a){(void 0===this.maxObservedTimestamp||this.maxObservedTimestamp.lessThanOrEqual(a))&&(this.maxObservedTimestamp=a)}getMaxObservedTimestamp(){return this.maxObservedTimestamp}notifyOnQueryResultChanges(a){let b=this.remoteQuerySet.remoteQueryResults(),c=new Map;for(let[a,d]of b){let b=this.state.queryToken(a);if(null!==b){let e={result:d,udfPath:this.state.queryPath(a),args:this.state.queryArgs(a)};c.set(b,e)}}let d=this.optimisticQueryResults.ingestQueryResultsFromServer(c,new Set(a.keys()));this.handleTransition({queries:d.map(a=>{let b=this.optimisticQueryResults.rawQueryResult(a);return{token:a,modification:{kind:"Updated",result:b}}}),reflectedMutations:Array.from(a).map(([a,b])=>({requestId:a,result:b})),timestamp:this.remoteQuerySet.timestamp()})}handleTransition(a){for(let b of this._onTransitionFns.values())b(a)}addOnTransitionHandler(a){let b=this._transitionHandlerCounter++;return this._onTransitionFns.set(b,a),()=>this._onTransitionFns.delete(b)}getCurrentAuthClaims(){let a=this.state.getAuth(),b={};if(a&&"User"===a.tokenType){try{b=a?_(a.value):{}}catch{b={}}return{token:a.value,decoded:b}}}setAuth(a,b){this.authenticationManager.setConfig(a,b)}hasAuth(){return this.state.hasAuth()}setAdminAuth(a,b){let c=this.state.setAdminAuth(a,b);this.webSocketManager.sendMessage(c)}clearAuth(){let a=this.state.clearAuth();this.webSocketManager.sendMessage(a)}subscribe(a,b,c){let d=(0,B.parseArgs)(b),{modification:e,queryToken:f,unsubscribe:g}=this.state.subscribe(a,d,c?.journal,c?.componentPath);return null!==e&&this.webSocketManager.sendMessage(e),{queryToken:f,unsubscribe:()=>{let a=g();a&&this.webSocketManager.sendMessage(a)}}}localQueryResult(a,b){let c=p(a,(0,B.parseArgs)(b));return this.optimisticQueryResults.queryResult(c)}localQueryResultByToken(a){return this.optimisticQueryResults.queryResult(a)}hasLocalQueryResultByToken(a){return this.optimisticQueryResults.hasQueryResult(a)}localQueryLogs(a,b){let c=p(a,(0,B.parseArgs)(b));return this.optimisticQueryResults.queryLogs(c)}queryJournal(a,b){let c=p(a,(0,B.parseArgs)(b));return this.state.queryJournal(c)}connectionState(){let a=this.webSocketManager.connectionState();return{hasInflightRequests:this.requestManager.hasInflightRequests(),isWebSocketConnected:a.isConnected,hasEverConnected:a.hasEverConnected,connectionCount:a.connectionCount,connectionRetries:a.connectionRetries,timeOfOldestInflightRequest:this.requestManager.timeOfOldestInflightRequest(),inflightMutations:this.requestManager.inflightMutations(),inflightActions:this.requestManager.inflightActions()}}subscribeToConnectionState(a){let b=this.nextConnectionStateSubscriberId++;return this.connectionStateSubscribers.set(b,a),()=>{this.connectionStateSubscribers.delete(b)}}async mutation(a,b,c){let d=await this.mutationInternal(a,b,c);if(!d.success){if(void 0!==d.errorData)throw n(d,new C.ConvexError(m("mutation",a,d)));throw Error(m("mutation",a,d))}return d.value}async mutationInternal(a,b,c,d){let{mutationPromise:e}=this.enqueueMutation(a,b,c,d);return e}enqueueMutation(a,b,c,e){let f=(0,B.parseArgs)(b);this.tryReportLongDisconnect();let g=this.nextRequestId;if(this._nextRequestId++,void 0!==c){let a=c.optimisticUpdate;if(void 0!==a){let b=b=>{a(b,f)instanceof Promise&&this.logger.warn("Optimistic update handler returned a Promise. Optimistic updates should be synchronous.")},c=this.optimisticQueryResults.applyOptimisticUpdate(b,g).map(a=>{let b=this.localQueryResultByToken(a);return{token:a,modification:{kind:"Updated",result:void 0===b?void 0:{success:!0,value:b,logLines:[]}}}});this.handleTransition({queries:c,reflectedMutations:[],timestamp:this.remoteQuerySet.timestamp()})}}let h={type:"Mutation",requestId:g,udfPath:a,componentPath:e,args:[(0,d.convexToJson)(f)]},i=this.webSocketManager.sendMessage(h);return{requestId:g,mutationPromise:this.requestManager.request(h,i)}}async action(a,b){let c=await this.actionInternal(a,b);if(!c.success){if(void 0!==c.errorData)throw n(c,new C.ConvexError(m("action",a,c)));throw Error(m("action",a,c))}return c.value}async actionInternal(a,b,c){let e=(0,B.parseArgs)(b),f=this.nextRequestId;this._nextRequestId++,this.tryReportLongDisconnect();let g={type:"Action",requestId:f,udfPath:a,componentPath:c,args:[(0,d.convexToJson)(e)]},h=this.webSocketManager.sendMessage(g);return this.requestManager.request(g,h)}async close(){return this.authenticationManager.stop(),this.webSocketManager.terminate()}get url(){return this.address}get nextRequestId(){return this._nextRequestId}get sessionId(){return this._sessionId}reportMarks(){if(this.debug){let a=function(a){if("undefined"==typeof performance||!performance.getEntriesByName)return[];let b=[];for(let c of ad){let d=performance.getEntriesByName(c).filter(a=>"mark"===a.entryType).filter(b=>b.detail.sessionId===a);b.push(...d)}return b.map(ae)}(this.sessionId);this.webSocketManager.sendMessage({type:"Event",eventType:"ClientConnect",event:a})}}tryReportLongDisconnect(){if(!this.debug)return;let a=this.connectionState().timeOfOldestInflightRequest;null===a||Date.now()-a.getTime()<=6e4||fetch(`${this.address}/api/debug_event`,{method:"POST",headers:{"Content-Type":"application/json","Convex-Client":`npm-${c.version}`},body:JSON.stringify({event:"LongWebsocketDisconnect"})}).then(a=>{a.ok||this.logger.warn("Analytics request failed with response:",a.body)}).catch(a=>{this.logger.warn("Analytics response failed with error:",a)})}}a.s(["BaseConvexClient",()=>ah],46727)},43971,39894,a=>{"use strict";let b;a.s([],43971),a.i(46727),a.i(93573);var c=a.i(54662),d=a.i(10092),e=a.i(50527);a.i(21338);var f=a.i(95487),g=a.i(59230),h=a.i(9075),i=Object.defineProperty,j=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?i(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};class k{constructor(a,b){if(j(this,"address"),j(this,"auth"),j(this,"adminAuth"),j(this,"encodedTsPromise"),j(this,"debug"),j(this,"fetchOptions"),j(this,"fetch"),j(this,"logger"),j(this,"mutationQueue",[]),j(this,"isProcessingQueue",!1),"boolean"==typeof b)throw Error("skipConvexDeploymentUrlCheck as the second argument is no longer supported. Please pass an options object, `{ skipConvexDeploymentUrlCheck: true }`.");!0!==(b??{}).skipConvexDeploymentUrlCheck&&(0,d.validateDeploymentUrl)(a),this.logger=b?.logger===!1?(0,h.instantiateNoopLogger)({verbose:!1}):b?.logger!==!0&&b?.logger?b.logger:(0,h.instantiateDefaultLogger)({verbose:!1}),this.address=a,this.debug=!0,this.auth=void 0,this.adminAuth=void 0,this.fetch=b?.fetch,b?.auth&&this.setAuth(b.auth)}backendUrl(){return`${this.address}/api`}get url(){return this.address}setAuth(a){this.clearAuth(),this.auth=a}setAdminAuth(a,b){if(this.clearAuth(),void 0!==b){let c=btoa(String.fromCodePoint(...new TextEncoder().encode(JSON.stringify(b))));this.adminAuth=`${a}:${c}`}else this.adminAuth=a}clearAuth(){this.auth=void 0,this.adminAuth=void 0}setDebug(a){this.debug=a}setFetchOptions(a){this.fetchOptions=a}async consistentQuery(a,...b){let c=(0,d.parseArgs)(b[0]),e=this.getTimestamp();return await this.queryInner(a,c,{timestampPromise:e})}async getTimestamp(){return this.encodedTsPromise?this.encodedTsPromise:this.encodedTsPromise=this.getTimestampInner()}async getTimestampInner(){let a=this.fetch||b||fetch,c={"Content-Type":"application/json","Convex-Client":`npm-${e.version}`},d=await a(`${this.address}/api/query_ts`,{...this.fetchOptions,method:"POST",headers:c});if(!d.ok)throw Error(await d.text());let{ts:f}=await d.json();return f}async query(a,...b){let c=(0,d.parseArgs)(b[0]);return await this.queryInner(a,c,{})}async queryInner(a,d,i){let j=(0,c.getFunctionName)(a),k=[(0,g.convexToJson)(d)],m={"Content-Type":"application/json","Convex-Client":`npm-${e.version}`};this.adminAuth?m.Authorization=`Convex ${this.adminAuth}`:this.auth&&(m.Authorization=`Bearer ${this.auth}`);let n=this.fetch||b||fetch,o=i.timestampPromise?await i.timestampPromise:void 0,p=JSON.stringify({path:j,format:"convex_encoded_json",args:k,...o?{ts:o}:{}}),q=o?`${this.address}/api/query_at_ts`:`${this.address}/api/query`,r=await n(q,{...this.fetchOptions,body:p,method:"POST",headers:m});if(!r.ok&&560!==r.status)throw Error(await r.text());let s=await r.json();if(this.debug)for(let a of s.logLines??[])(0,h.logForFunction)(this.logger,"info","query",j,a);switch(s.status){case"success":return(0,g.jsonToConvex)(s.value);case"error":if(void 0!==s.errorData)throw l(s.errorData,new f.ConvexError(s.errorMessage));throw Error(s.errorMessage);default:throw Error(`Invalid response: ${JSON.stringify(s)}`)}}async mutationInner(a,d){let i=(0,c.getFunctionName)(a),j=JSON.stringify({path:i,format:"convex_encoded_json",args:[(0,g.convexToJson)(d)]}),k={"Content-Type":"application/json","Convex-Client":`npm-${e.version}`};this.adminAuth?k.Authorization=`Convex ${this.adminAuth}`:this.auth&&(k.Authorization=`Bearer ${this.auth}`);let m=this.fetch||b||fetch,n=await m(`${this.address}/api/mutation`,{...this.fetchOptions,body:j,method:"POST",headers:k});if(!n.ok&&560!==n.status)throw Error(await n.text());let o=await n.json();if(this.debug)for(let a of o.logLines??[])(0,h.logForFunction)(this.logger,"info","mutation",i,a);switch(o.status){case"success":return(0,g.jsonToConvex)(o.value);case"error":if(void 0!==o.errorData)throw l(o.errorData,new f.ConvexError(o.errorMessage));throw Error(o.errorMessage);default:throw Error(`Invalid response: ${JSON.stringify(o)}`)}}async processMutationQueue(){if(!this.isProcessingQueue){for(this.isProcessingQueue=!0;this.mutationQueue.length>0;){let{mutation:a,args:b,resolve:c,reject:d}=this.mutationQueue.shift();try{let d=await this.mutationInner(a,b);c(d)}catch(a){d(a)}}this.isProcessingQueue=!1}}enqueueMutation(a,b){return new Promise((c,d)=>{this.mutationQueue.push({mutation:a,args:b,resolve:c,reject:d}),this.processMutationQueue()})}async mutation(a,...b){let[c,e]=b,f=(0,d.parseArgs)(c);return e?.skipQueue?await this.mutationInner(a,f):await this.enqueueMutation(a,f)}async action(a,...i){let j=(0,d.parseArgs)(i[0]),k=(0,c.getFunctionName)(a),m=JSON.stringify({path:k,format:"convex_encoded_json",args:[(0,g.convexToJson)(j)]}),n={"Content-Type":"application/json","Convex-Client":`npm-${e.version}`};this.adminAuth?n.Authorization=`Convex ${this.adminAuth}`:this.auth&&(n.Authorization=`Bearer ${this.auth}`);let o=this.fetch||b||fetch,p=await o(`${this.address}/api/action`,{...this.fetchOptions,body:m,method:"POST",headers:n});if(!p.ok&&560!==p.status)throw Error(await p.text());let q=await p.json();if(this.debug)for(let a of q.logLines??[])(0,h.logForFunction)(this.logger,"info","action",k,a);switch(q.status){case"success":return(0,g.jsonToConvex)(q.value);case"error":if(void 0!==q.errorData)throw l(q.errorData,new f.ConvexError(q.errorMessage));throw Error(q.errorMessage);default:throw Error(`Invalid response: ${JSON.stringify(q)}`)}}async function(a,i,...j){let k=(0,d.parseArgs)(j[0]),m="string"==typeof a?a:(0,c.getFunctionName)(a),n=JSON.stringify({componentPath:i,path:m,format:"convex_encoded_json",args:(0,g.convexToJson)(k)}),o={"Content-Type":"application/json","Convex-Client":`npm-${e.version}`};this.adminAuth?o.Authorization=`Convex ${this.adminAuth}`:this.auth&&(o.Authorization=`Bearer ${this.auth}`);let p=this.fetch||b||fetch,q=await p(`${this.address}/api/function`,{...this.fetchOptions,body:n,method:"POST",headers:o});if(!q.ok&&560!==q.status)throw Error(await q.text());let r=await q.json();if(this.debug)for(let a of r.logLines??[])(0,h.logForFunction)(this.logger,"info","any",m,a);switch(r.status){case"success":return(0,g.jsonToConvex)(r.value);case"error":if(void 0!==r.errorData)throw l(r.errorData,new f.ConvexError(r.errorMessage));throw Error(r.errorMessage);default:throw Error(`Invalid response: ${JSON.stringify(r)}`)}}}function l(a,b){return b.data=(0,g.jsonToConvex)(a),b}a.s(["ConvexHttpClient",()=>k],39894)},93573,95518,a=>{"use strict";let b;a.s(["ConvexClient",()=>o,"setDefaultWebSocketConstructor",()=>n],93573);var c=a.i(10092);a.i(43971);var d=a.i(46727),e=a.i(54662),f=a.i(8914);function g(a){if("object"!=typeof a||null===a||!Array.isArray(a.page)||"boolean"!=typeof a.isDone||"string"!=typeof a.continueCursor)throw Error(`Not a valid paginated query result: ${a?.toString()}`);return a}var h=a.i(89311),i=Object.defineProperty,j=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?i(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};class k{constructor(a,b){this.client=a,this.onTransition=b,j(this,"paginatedQuerySet",new Map),j(this,"lastTransitionTs"),this.lastTransitionTs=h.Long.fromNumber(0),this.client.addOnTransitionHandler(a=>this.onBaseTransition(a))}subscribe(a,b,c){let d=(0,f.canonicalizeUdfPath)(a),e=(0,f.serializePaginatedPathAndArgs)(d,b,c),g=()=>this.removePaginatedQuerySubscriber(e),h=this.paginatedQuerySet.get(e);return h?h.numSubscribers+=1:(this.paginatedQuerySet.set(e,{token:e,canonicalizedUdfPath:d,args:b,numSubscribers:1,options:{initialNumItems:c.initialNumItems},nextPageKey:0,pageKeys:[],pageKeyToQuery:new Map,ongoingSplits:new Map,skip:!1,id:c.id}),this.addPageToPaginatedQuery(e,null,c.initialNumItems)),{paginatedQueryToken:e,unsubscribe:g}}localQueryResult(a,b,c){let d=(0,f.canonicalizeUdfPath)(a),e=(0,f.serializePaginatedPathAndArgs)(d,b,c);return this.localQueryResultByToken(e)}localQueryResultByToken(a){let b,c=this.paginatedQuerySet.get(a);if(!c)return;let d=this.activePageQueryTokens(c);if(0===d.length)return{results:[],status:"LoadingFirstPage",loadMore:b=>this.loadMoreOfPaginatedQuery(a,b)};let e=[],f=!1,h=!1;for(let a of d){let b=this.client.localQueryResultByToken(a);if(void 0===b){f=!0,h=!1;continue}let c=g(b);e=e.concat(c.page),h=!!c.isDone}return b=f?0===e.length?"LoadingFirstPage":"LoadingMore":h?"Exhausted":"CanLoadMore",{results:e,status:b,loadMore:b=>this.loadMoreOfPaginatedQuery(a,b)}}onBaseTransition(a){let b=a.queries.map(a=>a.token),c=this.queriesContainingTokens(b),d=[];c.length>0&&(this.processPaginatedQuerySplits(c,a=>this.client.localQueryResultByToken(a)),d=c.map(a=>({token:a,modification:{kind:"Updated",result:this.localQueryResultByToken(a)}})));let e={...a,paginatedQueries:d};this.onTransition(e)}loadMoreOfPaginatedQuery(a,b){this.mustGetPaginatedQuery(a);let c=this.queryTokenForLastPageOfPaginatedQuery(a),d=this.client.localQueryResultByToken(c);if(!d)return!1;let e=g(d);if(e.isDone)return!1;this.addPageToPaginatedQuery(a,e.continueCursor,b);let f={timestamp:this.lastTransitionTs,reflectedMutations:[],queries:[],paginatedQueries:[{token:a,modification:{kind:"Updated",result:this.localQueryResultByToken(a)}}]};return this.onTransition(f),!0}queriesContainingTokens(a){if(0===a.length)return[];let b=[],c=new Set(a);for(let[a,d]of this.paginatedQuerySet)for(let e of this.allQueryTokens(d))if(c.has(e)){b.push(a);break}return b}processPaginatedQuerySplits(a,b){for(let c of a){let a=this.mustGetPaginatedQuery(c),{ongoingSplits:d,pageKeyToQuery:e,pageKeys:f}=a;for(let[c,[f,g]]of d)void 0!==b(e.get(f).queryToken)&&void 0!==b(e.get(g).queryToken)&&this.completePaginatedQuerySplit(a,c,f,g);for(let c of f){if(d.has(c))continue;let f=b(e.get(c).queryToken);if(!f)continue;let h=g(f);h.splitCursor&&("SplitRecommended"===h.pageStatus||"SplitRequired"===h.pageStatus||h.page.length>2*a.options.initialNumItems)&&this.splitPaginatedQueryPage(a,c,h.splitCursor,h.continueCursor)}}}splitPaginatedQueryPage(a,b,c,d){let e=a.nextPageKey++,f=a.nextPageKey++,g={cursor:d,numItems:a.options.initialNumItems,id:a.id},h=this.client.subscribe(a.canonicalizedUdfPath,{...a.args,paginationOpts:{...g,cursor:null,endCursor:c}});a.pageKeyToQuery.set(e,h);let i=this.client.subscribe(a.canonicalizedUdfPath,{...a.args,paginationOpts:{...g,cursor:c,endCursor:d}});a.pageKeyToQuery.set(f,i),a.ongoingSplits.set(b,[e,f])}addPageToPaginatedQuery(a,b,c){let d=this.mustGetPaginatedQuery(a),e=d.nextPageKey++,f={cursor:b,numItems:c,id:d.id},g={...d.args,paginationOpts:f},h=this.client.subscribe(d.canonicalizedUdfPath,g);return d.pageKeys.push(e),d.pageKeyToQuery.set(e,h),h}removePaginatedQuerySubscriber(a){let b=this.paginatedQuerySet.get(a);if(b&&(b.numSubscribers-=1,!(b.numSubscribers>0))){for(let a of b.pageKeyToQuery.values())a.unsubscribe();this.paginatedQuerySet.delete(a)}}completePaginatedQuerySplit(a,b,c,d){let e=a.pageKeyToQuery.get(b);a.pageKeyToQuery.delete(b);let f=a.pageKeys.indexOf(b);a.pageKeys.splice(f,1,c,d),a.ongoingSplits.delete(b),e.unsubscribe()}activePageQueryTokens(a){return a.pageKeys.map(b=>a.pageKeyToQuery.get(b).queryToken)}allQueryTokens(a){return Array.from(a.pageKeyToQuery.values()).map(a=>a.queryToken)}queryTokenForLastPageOfPaginatedQuery(a){let b=this.mustGetPaginatedQuery(a),c=b.pageKeys[b.pageKeys.length-1];if(void 0===c)throw Error(`No pages for paginated query ${a}`);return b.pageKeyToQuery.get(c).queryToken}mustGetPaginatedQuery(a){let b=this.paginatedQuerySet.get(a);if(!b)throw Error("paginated query no longer exists for token "+a);return b}}a.s(["PaginatedQueryClient",()=>k],95518);var l=Object.defineProperty,m=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?l(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};function n(a){b=a}class o{constructor(a,e={}){m(this,"listeners"),m(this,"_client"),m(this,"_paginatedClient"),m(this,"callNewListenersWithCurrentValuesTimer"),m(this,"_closed"),m(this,"_disabled"),!0!==e.skipConvexDeploymentUrlCheck&&(0,c.validateDeploymentUrl)(a);const{disabled:f,...g}=e;this._closed=!1,this._disabled=!!f,!b||"webSocketConstructor"in g||"undefined"!=typeof WebSocket||(g.webSocketConstructor=b),"unsavedChangesWarning"in g||(g.unsavedChangesWarning=!1),this.disabled||(this._client=new d.BaseConvexClient(a,()=>{},g),this._paginatedClient=new k(this._client,a=>this._transition(a))),this.listeners=new Set}get closed(){return this._closed}get client(){if(this._client)return this._client;throw Error("ConvexClient is disabled")}get paginatedClient(){if(this._paginatedClient)return this._paginatedClient;throw Error("ConvexClient is disabled")}get disabled(){return this._disabled}onUpdate(a,b,c,d){if(this.disabled)return this.createDisabledUnsubscribe();let{queryToken:f,unsubscribe:g}=this.client.subscribe((0,e.getFunctionName)(a),b),h={queryToken:f,callback:c,onError:d,unsubscribe:g,hasEverRun:!1,query:a,args:b,paginationOptions:void 0};this.listeners.add(h),this.queryResultReady(f)&&void 0===this.callNewListenersWithCurrentValuesTimer&&(this.callNewListenersWithCurrentValuesTimer=setTimeout(()=>this.callNewListenersWithCurrentValues(),0));let i={unsubscribe:()=>{this.closed||(this.listeners.delete(h),g())},getCurrentValue:()=>this.client.localQueryResultByToken(f),getQueryLogs:()=>this.client.localQueryLogs(f)},j=i.unsubscribe;return Object.assign(j,i),j}onPaginatedUpdate_experimental(a,b,c,d,f){if(this.disabled)return this.createDisabledUnsubscribe();let g={initialNumItems:c.initialNumItems,id:-1},{paginatedQueryToken:h,unsubscribe:i}=this.paginatedClient.subscribe((0,e.getFunctionName)(a),b,g),j={queryToken:h,callback:d,onError:f,unsubscribe:i,hasEverRun:!1,query:a,args:b,paginationOptions:g};this.listeners.add(j),this.paginatedClient.localQueryResultByToken(h)&&void 0===this.callNewListenersWithCurrentValuesTimer&&(this.callNewListenersWithCurrentValuesTimer=setTimeout(()=>this.callNewListenersWithCurrentValues(),0));let k={unsubscribe:()=>{this.closed||(this.listeners.delete(j),i())},getCurrentValue:()=>this.paginatedClient.localQueryResult((0,e.getFunctionName)(a),b,g),getQueryLogs:()=>[]},l=k.unsubscribe;return Object.assign(l,k),l}callNewListenersWithCurrentValues(){this.callNewListenersWithCurrentValuesTimer=void 0,this._transition({queries:[],paginatedQueries:[]},!0)}queryResultReady(a){return this.client.hasLocalQueryResultByToken(a)}createDisabledUnsubscribe(){let a=()=>{};return Object.assign(a,{unsubscribe:a,getCurrentValue:()=>void 0,getQueryLogs:()=>void 0}),a}async close(){if(!this.disabled)return this.listeners.clear(),this._closed=!0,this._paginatedClient&&(this._paginatedClient=void 0),this.client.close()}getAuth(){if(!this.disabled)return this.client.getCurrentAuthClaims()}setAuth(a,b){this.disabled||this.client.setAuth(a,b??(()=>{}))}setAdminAuth(a,b){if(this.closed)throw Error("ConvexClient has already been closed.");this.disabled||this.client.setAdminAuth(a,b)}_transition({queries:a,paginatedQueries:b},c=!1){let d=[...a.map(a=>a.token),...b.map(a=>a.token)];for(let a of this.listeners){let{callback:b,queryToken:e,onError:g,hasEverRun:h}=a,i=(0,f.serializedQueryTokenIsPaginated)(e),j=i?!!this.paginatedClient.localQueryResultByToken(e):this.client.hasLocalQueryResultByToken(e);if(d.includes(e)||c&&!h&&j){let c;a.hasEverRun=!0;try{c=i?this.paginatedClient.localQueryResultByToken(e):this.client.localQueryResultByToken(e)}catch(a){if(!(a instanceof Error))throw a;g?g(a,"Second argument to onUpdate onError is reserved for later use"):Promise.reject(a);continue}b(c,"Second argument to onUpdate callback is reserved for later use")}}}async mutation(a,b,c){if(this.disabled)throw Error("ConvexClient is disabled");return await this.client.mutation((0,e.getFunctionName)(a),b,c)}async action(a,b){if(this.disabled)throw Error("ConvexClient is disabled");return await this.client.action((0,e.getFunctionName)(a),b)}async query(a,b){if(this.disabled)throw Error("ConvexClient is disabled");let c=this.client.localQueryResult((0,e.getFunctionName)(a),b);return void 0!==c?Promise.resolve(c):new Promise((c,d)=>{let{unsubscribe:e}=this.onUpdate(a,b,a=>{e(),c(a)},a=>{e(),d(a)})})}connectionState(){if(this.disabled)throw Error("ConvexClient is disabled");return this.client.connectionState()}subscribeToConnectionState(a){return this.disabled?()=>{}:this.client.subscribeToConnectionState(a)}}},11241,96373,77926,a=>{"use strict";var b=a.i(72131);a.i(21338),a.s(["ConvexProvider",()=>k,"ConvexReactClient",()=>i],96373),a.i(43971);var c=a.i(46727);a.i(10092);var d=a.i(54662),e=a.i(9075),f=a.i(95518),g=Object.defineProperty,h=(a,b,c)=>{let d;return(d="symbol"!=typeof b?b+"":b)in a?g(a,d,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[d]=c};if(void 0===b.default)throw Error("Required dependency 'react' not found");class i{constructor(a,b){if(h(this,"address"),h(this,"cachedSync"),h(this,"cachedPaginatedQueryClient"),h(this,"listeners"),h(this,"options"),h(this,"closed",!1),h(this,"_logger"),h(this,"adminAuth"),h(this,"fakeUserIdentity"),void 0===a)throw Error("No address provided to ConvexReactClient.\nIf trying to deploy to production, make sure to follow all the instructions found at https://docs.convex.dev/production/hosting/\nIf running locally, make sure to run `convex dev` and ensure the .env.local file is populated.");if("string"!=typeof a)throw Error(`ConvexReactClient requires a URL like 'https://happy-otter-123.convex.cloud', received something of type ${typeof a} instead.`);if(!a.includes("://"))throw Error("Provided address was not an absolute URL.");this.address=a,this.listeners=new Map,this._logger=b?.logger===!1?(0,e.instantiateNoopLogger)({verbose:b?.verbose??!1}):b?.logger!==!0&&b?.logger?b.logger:(0,e.instantiateDefaultLogger)({verbose:b?.verbose??!1}),this.options={...b,logger:this._logger}}get url(){return this.address}get sync(){if(this.closed)throw Error("ConvexReactClient has already been closed.");return this.cachedSync||(this.cachedSync=new c.BaseConvexClient(this.address,()=>{},this.options),this.adminAuth&&this.cachedSync.setAdminAuth(this.adminAuth,this.fakeUserIdentity),this.cachedPaginatedQueryClient=new f.PaginatedQueryClient(this.cachedSync,a=>this.handleTransition(a))),this.cachedSync}get paginatedQueryClient(){if(this.sync,this.cachedPaginatedQueryClient)return this.cachedPaginatedQueryClient;throw Error("Should already be instantiated")}setAuth(a,b){if("string"==typeof a)throw Error("Passing a string to ConvexReactClient.setAuth is no longer supported, please upgrade to passing in an async function to handle reauthentication.");this.sync.setAuth(a,b??(()=>{}))}clearAuth(){this.sync.clearAuth()}setAdminAuth(a,b){if(this.adminAuth=a,this.fakeUserIdentity=b,this.closed)throw Error("ConvexReactClient has already been closed.");this.cachedSync&&this.sync.setAdminAuth(a,b)}watchQuery(a,...b){let[c,e]=b,f=(0,d.getFunctionName)(a);return{onUpdate:a=>{let{queryToken:b,unsubscribe:d}=this.sync.subscribe(f,c,e),g=this.listeners.get(b);return void 0!==g?g.add(a):this.listeners.set(b,new Set([a])),()=>{if(this.closed)return;let c=this.listeners.get(b);c.delete(a),0===c.size&&this.listeners.delete(b),d()}},localQueryResult:()=>{if(this.cachedSync)return this.cachedSync.localQueryResult(f,c)},localQueryLogs:()=>{if(this.cachedSync)return this.cachedSync.localQueryLogs(f,c)},journal:()=>{if(this.cachedSync)return this.cachedSync.queryJournal(f,c)}}}prewarmQuery(a){let b=a.extendSubscriptionFor??5e3;setTimeout(this.watchQuery(a.query,a.args||{}).onUpdate(()=>{}),b)}watchPaginatedQuery(a,b,c){let e=(0,d.getFunctionName)(a);return{onUpdate:a=>{let{paginatedQueryToken:d,unsubscribe:f}=this.paginatedQueryClient.subscribe(e,b||{},c),g=this.listeners.get(d);return void 0!==g?g.add(a):this.listeners.set(d,new Set([a])),()=>{if(this.closed)return;let b=this.listeners.get(d);b.delete(a),0===b.size&&this.listeners.delete(d),f()}},localQueryResult:()=>this.paginatedQueryClient.localQueryResult(e,b,c)}}mutation(a,...b){let[c,e]=b,f=(0,d.getFunctionName)(a);return this.sync.mutation(f,c,e)}action(a,...b){let c=(0,d.getFunctionName)(a);return this.sync.action(c,...b)}query(a,...b){let c=this.watchQuery(a,...b),d=c.localQueryResult();return void 0!==d?Promise.resolve(d):new Promise((a,b)=>{let d=c.onUpdate(()=>{d();try{a(c.localQueryResult())}catch(a){b(a)}})})}connectionState(){return this.sync.connectionState()}subscribeToConnectionState(a){return this.sync.subscribeToConnectionState(a)}get logger(){return this._logger}async close(){if(this.closed=!0,this.listeners=new Map,this.cachedPaginatedQueryClient&&(this.cachedPaginatedQueryClient=void 0),this.cachedSync){let a=this.cachedSync;this.cachedSync=void 0,await a.close()}}handleTransition(a){let b=a.queries.map(a=>a.token),c=a.paginatedQueries.map(a=>a.token);this.transition([...b,...c])}transition(a){for(let b of a){let a=this.listeners.get(b);if(a)for(let b of a)b()}}}let j=b.default.createContext(void 0),k=({client:a,children:c})=>b.default.createElement(j.Provider,{value:a},c);a.i(59230),a.i(81773),Symbol("includePageKeys"),Symbol("page"),a.i(95487);let l=(0,b.createContext)(void 0);function m(){let a=(0,b.useContext)(l);if(void 0===a)throw Error("Could not find `ConvexProviderWithAuth` (or `ConvexProviderWithClerk` or `ConvexProviderWithAuth0`) as an ancestor component. This component may be missing, or you might have two instances of the `convex/react` module loaded in your project.");return a}function n({children:a,client:c,useAuth:d}){let{isLoading:e,isAuthenticated:f,fetchAccessToken:g}=d(),[h,i]=(0,b.useState)(null);return e&&null!==h&&i(null),e||f||!1===h||i(!1),b.default.createElement(l.Provider,{value:{isLoading:null===h,isAuthenticated:f&&(h??!1)}},b.default.createElement(o,{authProviderAuthenticated:f,fetchAccessToken:g,authProviderLoading:e,client:c,setIsConvexAuthenticated:i}),b.default.createElement(k,{client:c},a),b.default.createElement(p,{authProviderAuthenticated:f,fetchAccessToken:g,authProviderLoading:e,client:c,setIsConvexAuthenticated:i}))}function o({authProviderAuthenticated:a,fetchAccessToken:c,authProviderLoading:d,client:e,setIsConvexAuthenticated:f}){return(0,b.useEffect)(()=>{let b=!0;if(a)return e.setAuth(c,a=>{b&&f(()=>a)}),()=>{b=!1,f(a=>!a&&null)}},[a,c,d,e,f]),null}function p({authProviderAuthenticated:a,fetchAccessToken:c,authProviderLoading:d,client:e,setIsConvexAuthenticated:f}){return(0,b.useEffect)(()=>{if(a)return()=>{e.clearAuth(),f(()=>null)}},[a,c,d,e,f]),null}a.s(["ConvexProviderWithAuth",()=>n,"useConvexAuth",()=>m],77926),a.s([],11241)}];

//# sourceMappingURL=node_modules_convex_dist_esm_2efc5c84._.js.map